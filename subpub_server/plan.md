# Plan

## Original Prompt

New Feature:

Now this pubsub server is working as a tray icon, we want to have the server register itself as a midi device and have a "mapping" file that takes inputs from the different channels (by name) and sends through as midi inputs. I want the server to basically also pretend it is a midi device (even if it is just visible as a tray icon). That means applications like ableton need to be able to see the available midi device, almost like it is jsut plugged into the computer.

## Overview of Code Files
- `src/main.rs`: Contains the application entry point (`main`), logging initialization, and tray icon setup.
- `src/server.rs`: Contains the core UDP server logic, including message processing and multicast discovery.
- `Cargo.toml`: Defines project dependencies (tokio, log, dashmap, tray-item, anyhow, crossbeam-channel, log4rs) and metadata.
- `Cargo.lock`: Records the exact versions of dependencies used.
- `.gitignore`: Specifies intentionally untracked files to ignore.
- `subpub_server.log`: Log file generated by the application.

## Important Decisions Log
- Updated `crossbeam-channel` from version "0.17" to "^0.5" to resolve compilation errors.
- Replaced `env_logger` with `log4rs` for more robust logging, including file output to `subpub_server.log`.
- Resolved Rust compiler error E0505 by correctly cloning `tokio::runtime::Handle` when spawning tasks.
- Refactored server logic into a separate `src/server.rs` module for better organization.
- Ensured `anyhow::Context` trait was in scope in `src/server.rs` to fix `E0599` (no method named `context`).
- Switched from `tray-item` to `tray-icon v0.20.1` for better macOS compatibility and menu features.
- Integrated `tao` event loop for macOS main thread requirements.

## Todo List
- [x] Figure out `cargo check` errors.
- [x] Fix `crossbeam-channel` version in `Cargo.toml`.
- [x] Fix compiler errors and warnings in `src/main.rs` (unused imports/variables, E0505).
- [x] Add `log4rs` dependency to `Cargo.toml`.
- [x] Implement file and console logging using `log4rs` in `src/main.rs`.
- [x] Address issue with tray icon not appearing on macOS (by integrating `tao` event loop).
- [x] Implement custom icon for tray application.
- [x] Refactor server logic into `src/server.rs`.
- [x] Switch from `tray-item` to `tray-icon v0.20.1`.
- [x] Update `plan.md` with learnings and resolutions (ongoing).
- [x] Reduce log verbosity and invert tray icon colors.
- [x] **New Feature: MIDI Integration**
  - [x] Research and select a suitable Rust MIDI library (e.g., `midir`).
  - [x] Add MIDI library dependency (`midir`, `serde`, `toml`) to `Cargo.toml`.
  - [x] Implement virtual MIDI output port creation in `src/midi_handler.rs`. (Resolved with `use midir::os::unix::VirtualOutput;`)
  - [x] Define the structure for `midi_mapping.toml` and corresponding Rust structs in `src/midi_handler.rs`.
  - [x] Implement loading and parsing of `midi_mapping.toml` in `src/midi_handler.rs`, including creating a default file.
  - [x] Modify `src/server.rs` to process pubsub messages based on mappings and send MIDI messages.
  - [x] Add tray menu options for MIDI control (e.g., reload mappings).
  - [x] Add logging for MIDI operations (debug logging in server, info/warn/error in handler).
- [ ] Attempt completion (after MIDI feature).

## Learning - 2025-06-03 - Cargo Check Fixes, Logging & Tray Icon

**Key Insights:**
- `crossbeam-channel` version `0.17` is outdated. Upgrading to `^0.5` resolves version selection errors.
- Rust compiler error E0505 ("cannot move out of `variable` because it is borrowed") with `tokio::runtime::Handle` requires careful cloning: one clone for `.spawn()`, another if moved into the `async` block.
- `log4rs` is a versatile logging crate. Configure programmatically for multiple appenders (console, file), log patterns, and levels. Remove old logger (e.g., `env_logger`) initializations.
- For `tray-item` v0.10.0 on macOS, if a specific icon resource isn't bundled (common with `cargo run`), `IconSource::Resource("")` can be used to request a default system icon or an empty space, making the tray item visible. Previous attempts like `IconSource::empty()`, `IconSource::None`, or Rust's `None` were incorrect for this version.
- Compiler error E0599 "no method named `context` found" for `Result` often means the `anyhow::Context` trait is not in scope. Add `use anyhow::Context;`.
- Modularizing code (e.g., moving server logic to `src/server.rs` and declaring `mod server;` in `src/main.rs`) improves organization. Update `use` statements in tests and other modules accordingly (e.g., `use super::server::SpecificItem;`).

**Resolutions:**
- `Cargo.toml`: `crossbeam-channel = "^0.5"`.
- `src/main.rs`:
    - Fixed E0505 by cloning `rt.handle()` correctly.
    - Implemented `init_logging()` with `log4rs` for file and console output. Removed `env_logger`.
    - Changed tray icon to `IconSource::Resource("")`.
    - Added `mod server;` and updated calls to use `server::...`.

## Learning - 2025-06-03 - Switching to `tray-icon` v0.20.1

**Key Insights:**
- `tray-icon` (v0.20.1) uses `muda` (e.g., v0.16.1) for its menu system. API details might come from `muda`'s documentation.
- **Icon Loading**: `tray_icon::Icon::from_path` is not available. Icons must be loaded manually (e.g., using the `image` crate) and then passed as RGBA data to `tray_icon::Icon::from_rgba(rgba_vec, width, height)`.
    - Requires `image = { version = "0.24", default-features = false, features = ["ico"] }` in `Cargo.toml`.
    - Requires `use image::GenericImageView;` in `src/main.rs`.
- **Menu Items**:
    - Use `tray_icon::menu::MenuItem` (re-exported from `muda`).
    - To create menu items with string IDs, use `MenuItem::with_id(id_str, text_str, enabled_bool, accelerator_option)`. Note the argument order: `id`, `text`, `enabled`, `accelerator`. The `accelerator` is an `Option`, so `None` is valid.
    - Add items to a `tray_icon::menu::Menu` instance using the `append()` method (e.g., `tray_menu.append(&menu_item)`).
- **Event Handling**:
    - `tray_icon` uses a polling model for events. `MenuEvent::receiver().try_recv()` and `TrayIconEvent::receiver().try_recv()` are called in a loop.
    - `MenuEvent.id` is a `MenuId` (likely a `muda::MenuId`). To get the string representation for matching, use `event.id.0.as_str()`.
    - When logging `MenuId`, use the debug formatter: `{:?}` (e.g., `info!("Menu event: {:?}", event.id);`).
- **Application Quit Logic**: A `std::sync::atomic::AtomicBool` can be used as a flag to signal the main event loop to terminate. Menu items can set this flag.
- **Dependencies**:
    - `Cargo.toml`: Replace `tray-item` with `tray-icon = "0.20.1"`. Re-add `image` if removed.
- **Main Loop**: A `loop` with a short `thread::sleep` (e.g., 50ms) is needed to poll for events without busy-waiting.

**Resolutions:**
- `Cargo.toml`:
    - Changed `tray-item = "..."` to `tray-icon = "0.20.1"`.
    - Ensured `image = { version = "0.24", default-features = false, features = ["ico"] }` is present.
- `src/main.rs`:
    - Updated `use` statements for `tray_icon` and `image::GenericImageView`.
    - Implemented icon loading using `image::open` and `Icon::from_rgba`.
    - Replaced `TrayItem` with `TrayIconBuilder`.
    - Replaced old menu creation with `Menu::new()`, `MenuItem::with_id()`, and `menu.append()`.
    - Implemented a main event loop polling `MenuEvent::receiver()` and `TrayIconEvent::receiver()`.
    - Adapted server start/stop logic to be triggered by menu event IDs within the new loop.
    - Used `event.id.0.as_str()` for matching menu item IDs.
    - Used `{:?}` for logging `event.id`.
    - Used `AtomicBool` for quit signalling.

## Learning - 2025-06-03 - macOS Tray Icon Visibility with `tao` Event Loop

**Key Insights:**
- **macOS Main Thread Requirement**: For GUI elements like tray icons to appear and function correctly on macOS, the main thread must run the primary event loop. A manual polling loop in Rust is often insufficient.
- **`tao` for Event Loop**: The `tao` crate (e.g., v0.25.0) can provide this OS-level event loop.
    - Add `tao = "0.25.0"` to `Cargo.toml`.
    - Use `tao::event_loop::EventLoopBuilder` to create an event loop.
    - For macOS tray/menu bar apps that don't have a main window, set the activation policy: `event_loop.set_activation_policy(tao::platform::macos::ActivationPolicy::Accessory);`. This requires `use tao::platform::macos::EventLoopExtMacOS;`.
- **Integrating `tray-icon` with `tao`**:
    - The `tray-icon` instance should be created before starting `tao`'s event loop. Ensure its lifetime persists while the loop runs (e.g., by binding it to `_tray_icon_instance` in `main`'s scope before `event_loop.run`).
    - The `tray-icon`'s event receivers (`MenuEvent::receiver()`, `TrayIconEvent::receiver()`) are polled inside `tao`'s event loop closure.
- **`tao` Event Loop Structure**:
    - `event_loop.run(move |_event, _, control_flow| { ... });` takes over the current thread.
    - Set `*control_flow = ControlFlow::Poll;` to continuously check for events.
    - To exit, set `*control_flow = ControlFlow::Exit;`.
- **Main Function Return**:
    - `event_loop.run()` typically does not return (its return type is `!`). Code after it in `main` will be flagged as unreachable.
    - If `main` returns `Result<()>`, this is for errors during setup *before* `event_loop.run()`. The function will not conventionally return `Ok(())` after the loop starts. Removing the final `Ok(())` (if `main`'s body ends with `event_loop.run()`) resolves unreachable code warnings and matches the diverging nature of `run()`.

**Resolutions:**
- `Cargo.toml`: Added `tao = "0.25.0"`.
- `src/main.rs`:
    - Added `use tao::{event_loop::{ControlFlow, EventLoopBuilder}, platform::macos::EventLoopExtMacOS};`.
    - Replaced the manual `loop` with `EventLoopBuilder::new().build()` and `event_loop.run(...)`.
    - Set `event_loop.set_activation_policy(tao::platform::macos::ActivationPolicy::Accessory)`.
    - Moved `MenuEvent::receiver().try_recv()` and `TrayIconEvent::receiver().try_recv()` polling into the `event_loop.run` closure.
    - Implemented application exit using `ControlFlow::Exit` based on the `quit_flag`.
    - Removed unused `std::thread` and `std::time::Duration` imports.
    - Removed unreachable `Ok(())` at the end of `main`.
    - Ensured `_tray_icon_instance` is created and kept in scope before `event_loop.run()`.

## Learning - 2025-06-03 - Log Reduction & Icon Inversion

**Key Insights:**
- **Log Verbosity**: Reduce noise by commenting out or removing `info!` calls for frequent, low-value events (e.g., every menu click or tray event). Retain logs for significant state changes (start/stop server), errors, and warnings.
- **Icon Color Inversion (RGBA)**:
    - Load icon image into a mutable RGBA buffer (e.g., `Vec<u8>` from `image::DynamicImage::to_rgba8().into_raw()`).
    - Iterate through the buffer in chunks of 4 bytes (R, G, B, A).
    - For each pixel, invert R, G, B components: `new_component = 255 - old_component`.
    - Leave the Alpha component (A) unchanged to preserve transparency.
    - Use the modified RGBA buffer to create the `tray_icon::Icon`.
    - Example:
      ```rust
      // let mut rgba = img.to_rgba8().into_raw(); // Make rgba mutable
      // for chunk in rgba.chunks_mut(4) {
      //     if chunk.len() == 4 {
      //         chunk[0] = 255 - chunk[0]; // Invert R
      //         chunk[1] = 255 - chunk[1]; // Invert G
      //         chunk[2] = 255 - chunk[2]; // Invert B
      //         // chunk[3] is Alpha, leave as is
      //     }
      // }
      // let icon = Icon::from_rgba(rgba, width, height)?;
      ```

**Resolutions:**
- `src/main.rs`:
    - Commented out `info!("Menu event: {:?}", menu_event);` and `info!("Tray event: {:?}", tray_event);` in the event loop.
    - Implemented RGB color inversion for the tray icon pixels, leaving alpha untouched.

## Learning - 2025-06-03 - MIDI Handler Implementation

**Key Insights:**
- **Virtual MIDI Port Creation (`midir` on macOS/Linux)**: The `create_virtual` method on `midir::MidiOutput` requires the `midir::os::unix::VirtualOutput` trait to be in scope. Add `use midir::os::unix::VirtualOutput;`.
- **Serde for TOML**:
    - To serialize structs to TOML (e.g., for writing a default config file), derive `serde::Serialize`.
    - To deserialize, derive `serde::Deserialize`.
    - Ensure all nested custom types also derive these traits.
- **MIDI Mapping File**: A `midi_mapping.toml` file can define rules for translating pub/sub messages to MIDI actions. Structs like `MidiMappingConfig`, `MappingEntry`, `MidiAction`, and `MidiActionType` (enum) can represent this configuration.
- **Loading Config**: It's robust to load the mapping file at startup, and if it's missing, create a default (empty or example) version and use that. This prevents errors if the file is accidentally deleted.
- **HashMap for Lookups**: For efficient processing, parsed MIDI mappings can be stored in a `HashMap<String, Vec<MidiAction>>` where the key is the pub/sub topic.

**Resolutions:**
- `Cargo.toml`: Added `midir = "0.9.1"`, `serde = { version = "1.0", features = ["derive"] }`, `toml = "0.8"`.
- `src/midi_handler.rs`:
    - Created `MidiHandler` struct.
    - Implemented `MidiHandler::new()` to initialize MIDI output and load mappings.
    - Added `load_mappings_from_file` to parse `midi_mapping.toml` (and create default if missing).
    - Defined `MidiMappingConfig`, `MappingEntry`, `MidiAction`, `MidiActionType` with `Deserialize` and `Serialize`.
    - Added `use midir::os::unix::VirtualOutput;` to resolve `create_virtual` method not found error.
    - Implemented `build_topic_map` to convert config into a `HashMap`.
    - Added `reload_mappings` public method.
- `src/main.rs`:
    - Added `mod midi_handler;` and `use crate::midi_handler::MidiHandler;`.
    - Initialized `MidiHandler` in `main()`.
- `midi_mapping.toml`: Created example mapping file.
